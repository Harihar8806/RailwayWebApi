CREATE TABLE STATIONS
(StationID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
 StationCode VARCHAR2(20) NOT NULL,
 StationName VARCHAR2(200) NOT NULL,
 CONSTRAINT UQ_Station_Code UNIQUE (StationCode));
 
 CREATE TABLE TRAINS
(TrainId NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
 Train_Name VARCHAR2(100) NOT NULL,
 TrainNumber NUMBER(20) NOT NULL UNIQUE,
 SourceStationID  NUMBER NOT NULL,
 SourceStationName VARCHAR2(60),
 DestnationStationID Number NOT NULL,
 DestnationStationName VARCHAR2(60),
 TotalDistance NUMBER,
 Train_Type VARCHAR2(200),
 CONSTRAINT FR_SOUR_K FOREIGN KEY (SourceStationID) REFERENCES STATIONS (StationID),
 CONSTRAINT FR_DEST_K FOREIGN KEY (DestnationStationID) REFERENCES STATIONS (StationID)
) ;

CREATE TABLE COACHES
(COACHID  NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
TrainId NUMBER NOT NULL,
CoachPosition NUMBER NOT NULL,
CoachNumber VARCHAR2(20) NOT NULL,--S1,B2
CoachType VARCHAR2(20) NOT NULL,
TotalSeates NUMBER NOT NULL,
CONSTRAINT FR_COACH_K FOREIGN KEY (TrainId) REFERENCES TRAINS (TrainId) ) ;


CREATE TABLE SEATES
(SeatId NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
 COACHID  NUMBER NOT NULL,
 SeatNumber NUMBER NOT NULL,
 Bearth  VARCHAR2(20) NOT NULL,
 CONSTRAINT FR_SEATES_K FOREIGN KEY (COACHID) REFERENCES COACHES(COACHID),
 CONSTRAINT UQ_SEATES_COACH_SEAT UNIQUE (COACHID,SeatNumber)
);


CREATE TABLE TRAINROUTES
(ROUTEID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
 TrainId NUMBER NOT NULL,
 StationID NUMBER NOT NULL,
 StationOrder NUmber NOT  NULL,
 ScheduleArrival  TIMESTAMP,
 ScheduleDeparture TIMESTAMP,
 PlatformNumber NUMBER NoT NULL,
 DAY  NUMBER,
 CONSTRAINT FK_TRAIN_K FOREIGN KEY (TrainId) REFERENCES TRAINS (TrainId),
 CONSTRAINT FK_Station_K FOREIGN KEY (StationID) REFERENCES STATIONS (StationID),
 CONSTRAINT UQ_TRAIN_STATION_ORDER UNIQUE(TrainId,StationOrder),
 CONSTRAINT UQ_TRAIN_STATION UNIQUE(TrainId,StationID)
 );
 
 
 CREATE TABLE StationSeatQuota
(QuotaID  NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
 TrainId NUMBER NOT NULL,
 StationID NUMBER NOT NULL,
 CoachType VARCHAR2(20) NOT NULL,
 ReservedSeates NUMBER NOT NULL,
 FOREIGN KEY (TrainId) REFERENCES TRAINS (TrainId),
 FOREIGN KEY (StationID) REFERENCES STATIONS (StationID),
 CONSTRAINT UQ_StationQuota UNIQUE (TrainId,StationID,CoachType)
 ) ;


CREATE TABLE FARES 
 (Frae_ID NUMBER  PRIMARY KEY,
 TRAINID  NUMBER NOT NULL,
 CoachType VARCHAR2(20) NOT NULL,
 FareAmount NUMBER(10,2) NOT NULL,
 FROMSTATIONID NUMBER NOT NULL,
 TOSTATIONID  NUMBER NOT NULL,
 STATIONID  NUMBER NOT NULL,
 FOREIGN KEY (TRAINID) REFERENCES TRAINS (TrainId),
  FOREIGN KEY (FROMSTATIONID) REFERENCES STATIONS (STATIONID),
   FOREIGN KEY (TOSTATIONID) REFERENCES STATIONS (STATIONID),
   CONSTRAINT UQ_FRAE_PR UNIQUE(TRAINID,TOSTATIONID,FROMSTATIONID)
  );

  CREATE TABLE Train_Running_Dates
  (RunID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  TrainId NUMBER NOT NULL,
  RunningDate  VARCHAR2(20) NOT NULL,
  FOREIGN KEY (TrainId) REFERENCES STATIONS (StationID),
  CONSTRAINT UQ_TrainDate UNIQUE(TrainId,RunningDate)
 ) ;

 CREATE TABLE DAILYSEATAVALIABILITY
 (AvailibleId NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
 TRAINID  NUMBER NOT NULL,
 RunningDate  DATE NOT NULL,
 FROMSTATIONID NUMBER NOT NULL,
 TOSTATIONID  NUMBER NOT NULL,
 COACH_TYPE  VARCHAR2(20) NOT NULL,
 SEATAVAILABLE  NUMBER NOT NULL,
 CONSTRAINT UQ_DILYAVAil UNIQUE (TRAINID,RunningDate,FROMSTATIONID,TOSTATIONID,COACH_TYPE),
 FOREIGN KEY (TrainId) REFERENCES TRAINS (TRAINID),
 FOREIGN KEY (FROMSTATIONID) REFERENCES STATIONS (StationID),
 FOREIGN KEY (TOSTATIONID) REFERENCES STATIONS (StationID)
 );

 CREATE TABLE Passengers
 (PassengerID Number Generated by Default as Identity PRIMARY key,
 FullName  Varchar2(100) NOT NULL,
 Age NUMBER,
 Gender Varchar2(20),
 Phone Varchar2(20),
 Email Varchar2(20));


 CREATE TABLE BOOKINGs
 (BookID  NUMBER Generated by default as identity Primary Key,
 TRAINID  NUMBER NOT NULL,
 PassengerID NUMBER NOT NULL,
 RunningDate  Date Not NULL,
 FROMSTATIONID NUMBER NOT NULL,
 TOSTATIONID  NUMBER NOT NULL,
 CoachType   Varchar2(20) NOT NULL,
 SeatBooked NUmber Default 1,
 BookingStatus  Varchar2(20) DEFAULT 'CONFIRMED',
 Booking_Date Timestamp Default Sysdate,
 FOREIGN KEY (TrainId) REFERENCES TRAINS (TRAINID),
 FOREIGN KEY (FROMSTATIONID) REFERENCES STATIONS (StationID),
 FOREIGN KEY (TOSTATIONID) REFERENCES STATIONS (StationID),
 FOREIGN KEY (PassengerID) REFERENCES Passengers (PassengerID)
 );


---DAILY TRAIN QUOTA QUERY FOR SLEEPER
SELECT QUOTATYPEID, SEATESRESERVED, QUOTANAME, BERTHTYPE, COACHTYPEID
 FROM QuotaType
 ORDER BY CASE WHEN QUOTANAME='Ladies' THEN 1
              WHEN QUOTANAME='Senior Citizen' THEN 2
              WHEN QUOTANAME='RAC' THEN 3
              WHEN QUOTANAME='MLA' THEN 4
              WHEN QUOTANAME='Tatkal' THEN 5
              WHEN QUOTANAME='General' THEN 6 END;
 
 BEGIN
 FOR I IN (SELECT CASE WHEN QUOTANAME='Ladies' THEN 1
              WHEN QUOTANAME='Senior Citizen' THEN 2
              WHEN QUOTANAME='RAC' THEN 3
              WHEN QUOTANAME='MLA' THEN 4
              WHEN QUOTANAME='Tatkal' THEN 5
              WHEN QUOTANAME='General' THEN 6 END IDD, SEATESRESERVED, QUOTANAME, BERTHTYPE, COACHTYPEID
 FROM QuotaType
 WHERE QUOTANAME IN ('Ladies','Senior Citizen','RAC')
 ORDER BY CASE WHEN QUOTANAME='Ladies' THEN 1
              WHEN QUOTANAME='Senior Citizen' THEN 2
              WHEN QUOTANAME='RAC' THEN 3
              WHEN QUOTANAME='MLA' THEN 4
              WHEN QUOTANAME='Tatkal' THEN 5
              WHEN QUOTANAME='General' THEN 6 END)
 LOOP
 
 UPDATE TEMP_DAILYSEATSAVAILBILITY A
SET A.QUOTANAME=I.QUOTANAME
WHERE (TRAINID, RESERVARTION_DATE, COACHNUMBER, COACHTYPE, SEATNUMBER, BEARTH) IN
(SELECT TRAINID, RESERVARTION_DATE, COACHNUMBER, COACHTYPE, SEATNUMBER, BEARTH
 FROM (
 SELECT TRAINID, RESERVARTION_DATE, COACHNUMBER, COACHTYPE, SEATNUMBER, BEARTH,
        ROW_NUMBER() OVER(PARTITION BY COACHNUMBER ORDER BY SEATNUMBER) RK
 FROM TEMP_DAILYSEATSAVAILBILITY
 WHERE QUOTANAME IS NULL AND BEARTH=I.BERTHTYPE )
 WHERE RK<=I.SEATESRESERVED);
END LOOP;

 FOR I IN (SELECT CASE WHEN QUOTANAME='Ladies' THEN 1
              WHEN QUOTANAME='Senior Citizen' THEN 2
              WHEN QUOTANAME='RAC' THEN 3
              WHEN QUOTANAME='MLA' THEN 4
              WHEN QUOTANAME='Tatkal' THEN 5
              WHEN QUOTANAME='General' THEN 6 END IDD, SEATESRESERVED, QUOTANAME, BERTHTYPE, COACHTYPEID
 FROM QuotaType
 WHERE QUOTANAME NOT IN ('Ladies','Senior Citizen','RAC')
 ORDER BY CASE WHEN QUOTANAME='Ladies' THEN 1
              WHEN QUOTANAME='Senior Citizen' THEN 2
              WHEN QUOTANAME='RAC' THEN 3
              WHEN QUOTANAME='MLA' THEN 4
              WHEN QUOTANAME='Tatkal' THEN 5
              WHEN QUOTANAME='General' THEN 6 END)
 LOOP
 
 UPDATE TEMP_DAILYSEATSAVAILBILITY A
SET A.QUOTANAME=I.QUOTANAME
WHERE (TRAINID, RESERVARTION_DATE, COACHNUMBER, COACHTYPE, SEATNUMBER, BEARTH) IN
(SELECT TRAINID, RESERVARTION_DATE, COACHNUMBER, COACHTYPE, SEATNUMBER, BEARTH
 FROM (
 SELECT TRAINID, RESERVARTION_DATE, COACHNUMBER, COACHTYPE, SEATNUMBER, BEARTH,
        ROW_NUMBER() OVER(PARTITION BY COACHNUMBER ORDER BY SEATNUMBER) RK
 FROM TEMP_DAILYSEATSAVAILBILITY
 WHERE QUOTANAME IS NULL  )
 WHERE RK<=I.SEATESRESERVED);
END LOOP;
END;

SELECT QUOTANAME,COUNT(1)
FROM TEMP_DAILYSEATSAVAILBILITY
WHERE COACHNUMBER='S6'
GROUP BY QUOTANAME;


INSERT INTO TEMP_DAILYSEATSAVAILBILITY
WITH CET1 AS
(SELECT TRAINID, COACHPOSITION, COACHNUMBER, COACHTYPE, TOTALSEATES 
FROM COACHES 
WHERE TRAINID=2
ORDER BY TRAINID),
CET2 AS
(SELECT  COACHTYPE, SEATNUMBER, BEARTH FROM SEATES)
SELECT T1.TRAINID,TO_DATE('18-OCT-2025','DD-MM-YYYY') RESERVARTION_DATE,  T1.COACHNUMBER, T1.COACHTYPE, T2.SEATNUMBER, T2.BEARTH,NULL
FROM CET1 T1 JOIN CET2 T2 ON (T1.COACHTYPE=T2.COACHTYPE)
WHERE T1.COACHTYPE='SL'
ORDER BY T1.COACHNUMBER,T2.SEATNUMBER;	


SELECT * FROM TEMP_DAILYSEATSAVAILBILITY;


--Swagger Link
https://localhost:7237/index.html







DECLARE
V_STARTID NUMBER;
V_ENDID NUMBER;
V_COUNT  NUMBER;
V_STATIONID  NUMBER :=29;
V_ENDSTATIONID NUMBER:=29;
V_SEATNUMBER  NUMBER :=7;
V_BOOKID  NUMBER;
BEGIN
  SELECT STATIONORDER   INTO V_STARTID FROM TEMP_DURANTO WHERE STATIONID=V_STATIONID AND SEATNUMBER=V_SEATNUMBER;
  SELECT STATIONORDER   INTO V_ENDID FROM TEMP_DURANTO WHERE STATIONID=V_ENDSTATIONID AND SEATNUMBER=V_SEATNUMBER;
  DBMS_OUTPUT.PUT_LINE(V_STARTID||' '||V_ENDID);
  SELECT COUNT(1) INTO V_COUNT
  FROM TEMP_DURANTO
  WHERE SEATNUMBER=V_SEATNUMBER
  AND STATUS='BOOKED'
  AND STATIONORDER  >= V_STARTID AND STATIONORDER < V_ENDID;
  IF V_COUNT > 0
  THEN 
  DBMS_OUTPUT.PUT_LINE('The Seat Is Already Booked');
  END IF;
  IF V_COUNT=0 THEN
  
  
  INSERT INTO BOOKINGS (BOOKID,
TRAINID,
PASSENGERID,
RUNNINGDATE,
FROMSTATIONID,
TOSTATIONID,
COACHTYPE,SEATNUMBER) VALUES (7,2,2,SYSDATE,V_STATIONID,V_ENDSTATIONID,'SL',V_SEATNUMBER);
  
  
  SELECT DISTINCT BOOKID INTO V_BOOKID
  FROM BOOKINGS WHERE TRAINID=2 AND FROMSTATIONID=V_STATIONID AND TOSTATIONID=V_ENDSTATIONID AND SEATNUMBER=V_SEATNUMBER;
  
  UPDATE TEMP_DURANTO
  SET STATUS='BOOKED',BOOKING_ID=V_BOOKID
  WHERE SEATNUMBER=V_SEATNUMBER
  AND STATIONORDER  >= V_STARTID AND STATIONORDER < V_ENDID;
  --AND STATIONORDER  BETWEEN V_STARTID AND V_ENDID;
  
  COMMIT;
  END IF;
END;
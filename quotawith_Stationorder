
WITH CET1 AS
(SELECT A.TRAINID,  A.COACHNUMBER, A.COACHTYPE, B.SEATNUMBER, B.BEARTH FROM 
(SELECT * FROM COACHES 
WHERE TRAINID=2 AND COACHTYPE='SL')A JOIN
(SELECT * FROM SEATES WHERE COACHTYPE='SL') B
ON (A.COACHTYPE=B.COACHTYPE)
WHERE A.COACHNUMBER='S1'),
CET2 AS
(SELECT TRAINID, STATIONID, STATIONORDER 
FROM TRAINROUTES WHERE TRAINID=2 ORDER BY STATIONORDER)
SELECT T2.TRAINID, T2.STATIONID, T2.STATIONORDER, T1.COACHNUMBER, T1.COACHTYPE, T1.SEATNUMBER, T1.BEARTH
FROM CET1 T1 JOIN CET2 T2 ON (T1.TRAINID=T2.TRAINID)
WHERE  T1.SEATNUMBER=1;

CREATE TABLE TEMP_DAILY_SEAT
AS
SELECT A.TRAINID,  A.COACHNUMBER, A.COACHTYPE, B.SEATNUMBER, B.BEARTH FROM 
(SELECT * FROM COACHES 
WHERE TRAINID=2 AND COACHTYPE='SL')A JOIN
(SELECT * FROM SEATES WHERE COACHTYPE='SL') B
ON (A.COACHTYPE=B.COACHTYPE)
WHERE A.COACHNUMBER='S1';


 BEGIN
 FOR I IN (SELECT CASE WHEN QUOTANAME='Ladies' THEN 1
              WHEN QUOTANAME='Senior Citizen' THEN 2
              WHEN QUOTANAME='RAC' THEN 3
              WHEN QUOTANAME='MLA' THEN 4
              WHEN QUOTANAME='Tatkal' THEN 5
              WHEN QUOTANAME='General' THEN 6 END IDD, SEATESRESERVED, QUOTANAME, BERTHTYPE, COACHTYPEID
 FROM QuotaType
 WHERE QUOTANAME IN ('Ladies','Senior Citizen','RAC')
 ORDER BY CASE WHEN QUOTANAME='Ladies' THEN 1
              WHEN QUOTANAME='Senior Citizen' THEN 2
              WHEN QUOTANAME='RAC' THEN 3
              WHEN QUOTANAME='MLA' THEN 4
              WHEN QUOTANAME='Tatkal' THEN 5
              WHEN QUOTANAME='General' THEN 6 END)
 LOOP
 
 UPDATE TEMP_DAILY_SEAT A
SET A.QUOTANAME=I.QUOTANAME
WHERE (TRAINID, RESERVARTION_DATE, COACHNUMBER, COACHTYPE, SEATNUMBER, BEARTH) IN
(SELECT TRAINID, RESERVARTION_DATE, COACHNUMBER, COACHTYPE, SEATNUMBER, BEARTH
 FROM (
 SELECT TRAINID, RESERVARTION_DATE, COACHNUMBER, COACHTYPE, SEATNUMBER, BEARTH,
        ROW_NUMBER() OVER(PARTITION BY COACHNUMBER ORDER BY SEATNUMBER) RK
 FROM TEMP_DAILY_SEAT
 WHERE QUOTANAME IS NULL AND BEARTH=I.BERTHTYPE )
 WHERE RK<=I.SEATESRESERVED);
END LOOP;

 FOR I IN (SELECT CASE WHEN QUOTANAME='Ladies' THEN 1
              WHEN QUOTANAME='Senior Citizen' THEN 2
              WHEN QUOTANAME='RAC' THEN 3
              WHEN QUOTANAME='MLA' THEN 4
              WHEN QUOTANAME='Tatkal' THEN 5
              WHEN QUOTANAME='General' THEN 6 END IDD, SEATESRESERVED, QUOTANAME, BERTHTYPE, COACHTYPEID
 FROM QuotaType
 WHERE QUOTANAME NOT IN ('Ladies','Senior Citizen','RAC')
 ORDER BY CASE WHEN QUOTANAME='Ladies' THEN 1
              WHEN QUOTANAME='Senior Citizen' THEN 2
              WHEN QUOTANAME='RAC' THEN 3
              WHEN QUOTANAME='MLA' THEN 4
              WHEN QUOTANAME='Tatkal' THEN 5
              WHEN QUOTANAME='General' THEN 6 END)
 LOOP
 
 UPDATE TEMP_DAILY_SEAT A
SET A.QUOTANAME=I.QUOTANAME
WHERE (TRAINID, RESERVARTION_DATE, COACHNUMBER, COACHTYPE, SEATNUMBER, BEARTH) IN
(SELECT TRAINID, RESERVARTION_DATE, COACHNUMBER, COACHTYPE, SEATNUMBER, BEARTH
 FROM (
 SELECT TRAINID, RESERVARTION_DATE, COACHNUMBER, COACHTYPE, SEATNUMBER, BEARTH,
        ROW_NUMBER() OVER(PARTITION BY COACHNUMBER ORDER BY SEATNUMBER) RK
 FROM TEMP_DAILY_SEAT
 WHERE QUOTANAME IS NULL  )
 WHERE RK<=I.SEATESRESERVED);
END LOOP;
END;

CREATE TABLE TEMP_DAILY_SEAT_2
AS
WITH CET1 AS
(SELECT A.TRAINID,  A.COACHNUMBER, A.COACHTYPE, A.SEATNUMBER, A.BEARTH,A.QUOTANAME FROM 
TEMP_DAILY_SEAT A),
CET2 AS
(SELECT TRAINID, STATIONID, STATIONORDER 
FROM TRAINROUTES WHERE TRAINID=2 ORDER BY STATIONORDER)
SELECT T2.TRAINID, T2.STATIONID, T2.STATIONORDER, T1.COACHNUMBER, T1.COACHTYPE, T1.SEATNUMBER, T1.BEARTH,T1.QUOTANAME
FROM CET1 T1 JOIN CET2 T2 ON (T1.TRAINID=T2.TRAINID)
;


SELECT QUOTANAME,COUNT(1) FROM TEMP_DAILY_SEAT_2 WHERE QUOTANAME='Tatkal' AND COACHNUMBER='S1' GROUP BY QUOTANAME;




----Fare Calculation
SELECT F.TRAIN_TYPE, F.COACH_TYPE,(ABS(TR2.DISTANCE-TR1.DISTANCE)*F.RATEPERKM) FARE
FROM TRAINROUTES TR1 JOIN
    TRAINROUTES TR2 ON (TR1.TRAINID=TR2.TRAINID) JOIN
    TRAINS T ON (TR1.TRAINID=T.TRAINID) JOIN
    FARES F ON (T.TRAIN_TYPE=F.TRAIN_TYPE)
WHERE TR1.TRAINID=2
AND TR1.STATIONID=1
AND TR2.STATIONID=29
AND F.COACH_TYPE='SL';